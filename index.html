<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pantry Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic enhancements */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 2rem;
        }
        .container-card {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
            max-width: 95%;
            width: 1000px;
            background: white;
            padding: 2rem;
        }
        .item-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border-left: 5px solid #3b82f6; /* Blue border for visual focus */
            /* Ensure item card is a flex container for image layout */
            display: flex;
            align-items: center;
        }
        .item-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        }
        .delete-btn {
            transition: background-color 0.15s;
        }
        .delete-btn:hover {
            background-color: #ef4444; /* Red hover */
        }
        @media (max-width: 768px) {
            .container-card {
                padding: 1.5rem 1rem;
            }
        }
        /* Style for the loading/status box */
        #status-message {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 500;
        }
        .error {
            background-color: #fecaca;
            color: #dc2626;
        }
        .success {
            background-color: #d1fae5;
            color: #059669;
        }
    </style>
</head>
<body>

<div class="container-card rounded-xl">
    <h1 class="text-4xl font-extrabold text-gray-900 mb-2">My Digital Pantry</h1>
    <p class="text-gray-500 mb-6">A real-time inventory tracker for essential items.</p>

    <!-- Status Message Area -->
    <div id="status-message" class="hidden"></div>

    <!-- Add New Item Form -->
    <div class="p-6 bg-blue-50 rounded-lg mb-8 shadow-inner">
        <h2 class="text-2xl font-semibold text-blue-800 mb-4">Add New Item</h2>
        <form id="addItemForm" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            <div class="md:col-span-2">
                <label for="name" class="block text-sm font-medium text-gray-700">Item Name (e.g., Pasta)</label>
                <input type="text" id="name" required placeholder="Milk, Flour, Eggs..."
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div>
                <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
                <input type="number" id="quantity" value="1" min="1" required
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-blue-500 focus:ring-blue-500">
            </div>
            <div class="md:col-span-2">
                <label for="unit" class="block text-sm font-medium text-gray-700">Unit (e.g., box, liter)</label>
                <input type="text" id="unit" placeholder="Can, Bag, kg, oz..."
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2.5 focus:border-blue-500 focus:ring-blue-500">
            </div>
            <button type="submit"
                    class="md:col-span-5 md:col-start-1 bg-blue-600 text-white font-bold py-2.5 rounded-lg hover:bg-blue-700 transition duration-150 transform hover:scale-[1.01] shadow-md">
                Add to Pantry
            </button>
        </form>
    </div>

    <!-- User ID Display -->
    <p class="text-sm text-gray-500 mb-4">
        <span class="font-semibold text-gray-700">User ID:</span> <span id="user-id-display">Loading...</span>
    </p>

    <!-- Pantry List -->
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Current Inventory</h2>
    <div id="pantry-list" class="space-y-3">
        <!-- Items will be injected here by JavaScript -->
        <div class="text-gray-500 p-4 text-center border border-gray-200 rounded-lg" id="loading-indicator">
            <svg class="animate-spin h-5 w-5 mr-3 inline-block text-blue-500" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading pantry data...
        </div>
    </div>
</div>

<script type="module">
    // --- FIREBASE IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, onSnapshot, addDoc, deleteDoc, query, orderBy, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Set Firestore log level to debug for better console feedback
    setLogLevel('Debug');

    // Global Firebase and App variables (Mandatory for this environment)
    let app, db, auth, userId;
    let isAuthReady = false;

    // Get mandatory global variables
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pantry-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // DOM elements
    const pantryListEl = document.getElementById('pantry-list');
    const addItemForm = document.getElementById('addItemForm');
    const statusMessageEl = document.getElementById('status-message');
    const userIdDisplayEl = document.getElementById('user-id-display');
    const loadingIndicator = document.getElementById('loading-indicator');

    // --- UTILITY FUNCTIONS ---

    /**
     * Shows a status message (success or error) to the user.
     * @param {string} message - The message to display.
     * @param {string} type - 'success' or 'error'.
     */
    function showStatus(message, type) {
        statusMessageEl.textContent = message;
        statusMessageEl.className = 'status-' + type;
        statusMessageEl.classList.remove('hidden', 'error', 'success');
        statusMessageEl.classList.add(type);
        setTimeout(() => {
            statusMessageEl.classList.add('hidden');
        }, 5000);
    }

    /**
     * Gets the collection path for the current user's private pantry items.
     * Path: /artifacts/{appId}/users/{userId}/pantry_items
     * @returns {string} The full collection path.
     */
    function getCollectionPath() {
        if (!userId) {
            console.error("User ID is not defined.");
            return null;
        }
        // Using the private data path structure as mandated
        return `artifacts/${appId}/users/${userId}/pantry_items`;
    }

    /**
     * Generates a placeholder image URL based on the item name, using emojis.
     * @param {string} name - The name of the item.
     * @returns {string} The placeholder image URL.
     */
    function generatePlaceholderUrl(name) {
        // Map common pantry item keywords to relevant emojis
        const itemMap = {
            'milk': '🥛',
            'egg': '🥚',
            'flour': '🍚', // generic grain/powder
            'rice': '🍚',
            'pasta': '🍝',
            'bread': '🍞',
            'can': '🥫',
            'coffee': '☕',
            'tea': '🍵',
            'sugar': '🍬', // generic sweet
            'salt': '🧂',
            'water': '💧',
            'oil': '🍾', // generic bottle
            'cereal': '🥣', // bowl
            'fruit': '🍎',
            'vegetable': '🥦',
            'tuna': '🐟',
            'chicken': '🍗',
            'soup': '🍲',
            'cheese': '🧀',
            'butter': '🧈'
        };

        const lowerName = name.toLowerCase();
        let emoji = '📦'; // Default package icon

        // Search for keywords in the name
        for (const keyword in itemMap) {
            if (lowerName.includes(keyword)) {
                emoji = itemMap[keyword];
                break;
            }
        }

        const safeEmoji = encodeURIComponent(emoji);
        // Using placehold.co to display the emoji with custom styling
        // Background: very light blue (#f0f4f8), Text: dark blue (#1e3a8a)
        // Font size increased to make the emoji clearly visible
        return `https://placehold.co/64x64/f0f4f8/1e3a8a?text=${safeEmoji}&font=arial&css={"font-size":"30px"}`;
    }


    // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

    /**
     * Initializes Firebase and handles user authentication.
     */
    async function initializeFirebase() {
        try {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                // Fallback UI update if config is missing
                userIdDisplayEl.textContent = "Error: Firebase configuration missing.";
                showStatus("Error: Cannot connect to database. Configuration missing.", 'error');
                return;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Set up Authentication Listener
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplayEl.textContent = userId;
                    isAuthReady = true;
                    // Once authenticated, start the real-time listener
                    setupRealtimeListener();
                } else {
                    // Sign in if no user is present
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            userIdDisplayEl.textContent = `Error: ${error.message}`;
            showStatus("Failed to initialize database connection.", 'error');
        }
    }

    // --- CRUD OPERATIONS ---

    /**
     * Adds a new item to the Firestore pantry collection.
     * @param {Event} e - The form submission event.
     */
    async function addItem(e) {
        e.preventDefault();
        if (!isAuthReady || !db) {
            showStatus("Database connection not ready. Please wait.", 'error');
            return;
        }

        const nameInput = document.getElementById('name');
        const quantityInput = document.getElementById('quantity');
        const unitInput = document.getElementById('unit');

        const name = nameInput.value.trim();
        const quantity = parseInt(quantityInput.value, 10);
        const unit = unitInput.value.trim() || 'unit(s)'; // Default unit

        if (!name || isNaN(quantity) || quantity <= 0) {
            showStatus("Please enter a valid item name and quantity.", 'error');
            return;
        }

        const itemData = {
            name: name,
            quantity: quantity,
            unit: unit,
            createdAt: Date.now(), // Store a timestamp for sorting
        };

        try {
            const path = getCollectionPath();
            await addDoc(collection(db, path), itemData);

            nameInput.value = ''; // Clear input fields
            quantityInput.value = '1';
            unitInput.value = '';
            showStatus(`"${name}" added successfully!`, 'success');

        } catch (error) {
            console.error("Error adding document: ", error);
            showStatus(`Error adding item: ${error.message}`, 'error');
        }
    }

    /**
     * Deletes an item from the Firestore pantry collection.
     * @param {string} id - The document ID of the item to delete.
     */
    async function deleteItem(id) {
        if (!isAuthReady || !db) {
            showStatus("Database connection not ready. Please wait.", 'error');
            return;
        }

        try {
            const path = getCollectionPath();
            await deleteDoc(doc(db, path, id));
            // UI update handled by onSnapshot listener
            showStatus("Item removed from pantry.", 'success');
        } catch (error) {
            console.error("Error deleting document: ", error);
            showStatus(`Error deleting item: ${error.message}`, 'error');
        }
    }

    // --- UI RENDERING & REAL-TIME LISTENER ---

    /**
     * Renders the list of pantry items to the DOM.
     * @param {Array<Object>} items - Array of item objects (with doc id and data).
     */
    function renderPantryItems(items) {
        loadingIndicator.classList.add('hidden');
        pantryListEl.innerHTML = ''; // Clear previous items

        if (items.length === 0) {
            pantryListEl.innerHTML = `
                <div class="p-6 bg-yellow-50 text-center rounded-lg border-2 border-dashed border-yellow-300">
                    <p class="text-lg font-medium text-yellow-800">Your pantry is empty!</p>
                    <p class="text-sm text-yellow-600">Use the form above to start adding items.</p>
                </div>
            `;
            return;
        }

        items.forEach(item => {
            const imageUrl = generatePlaceholderUrl(item.data.name);

            const itemEl = document.createElement('div');
            itemEl.className = 'item-card flex justify-between items-center p-4 bg-white rounded-xl shadow-sm border border-gray-100 space-x-4';
            itemEl.innerHTML = `
                <!-- Item Image/Placeholder -->
                <div class="flex-shrink-0 w-16 h-16 rounded-lg overflow-hidden border border-gray-200">
                    <img src="${imageUrl}" alt="${item.data.name} visual icon"
                         class="w-full h-full object-cover">
                </div>

                <div class="flex-grow min-w-0">
                    <p class="text-xl font-medium text-gray-800 truncate">${item.data.name}</p>
                    <p class="text-sm text-gray-500 mt-1">
                        <span class="font-bold text-gray-700">${item.data.quantity}</span> ${item.data.unit}
                    </p>
                </div>
                <button data-id="${item.id}"
                        class="delete-btn bg-red-500 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center shadow-lg transition duration-150 flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            `;
            pantryListEl.appendChild(itemEl);
        });

        // Attach click listeners to all new delete buttons
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const itemId = e.currentTarget.getAttribute('data-id');
                deleteItem(itemId);
            });
        });
    }

    /**
     * Sets up the real-time listener for the Firestore collection.
     */
    function setupRealtimeListener() {
        const path = getCollectionPath();
        if (!path) return;

        // Create a query to order the items by creation date (latest first)
        // NOTE: OrderBy is commented out to avoid potential index-related runtime errors.
        // We will sort client-side instead.
        const pantryQuery = collection(db, path); // query(collection(db, path), orderBy('createdAt', 'desc'));

        onSnapshot(pantryQuery, (snapshot) => {
            const items = [];
            snapshot.forEach(doc => {
                items.push({ id: doc.id, data: doc.data() });
            });

            // Client-side sort by createdAt (descending)
            items.sort((a, b) => b.data.createdAt - a.data.createdAt);

            renderPantryItems(items);
        }, (error) => {
            console.error("Realtime listener failed: ", error);
            showStatus(`Failed to load data: ${error.message}`, 'error');
            loadingIndicator.textContent = "Error loading data. Check console.";
        });
    }


    // --- MAIN EXECUTION ---
    window.addEventListener('load', () => {
        initializeFirebase();
        addItemForm.addEventListener('submit', addItem);
    });

</script>
</body>
</html>
